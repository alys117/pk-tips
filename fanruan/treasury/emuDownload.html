<html>
<head>
    <title>æ¨¡æ‹Ÿé‡‘åº“</title>
    <meta charset="UTF-8">
    <script src="./js/tools.js"></script>
</head>
<body>
  <span id="token-in-sessionStorage"></span><br>
  <input id="inputuser" type="text" value="wangyuanchao7"><br>
  <button id="jkdownBtn">æ¨¡æ‹Ÿé‡‘åº“ä¸‹è½½</button>
<script>
    (function (){
      var token1 = sessionStorage.getItem('token')
      document.getElementById('token-in-sessionStorage').innerHTML = 'token-in-sessionStorage >> ' + token1
    })()

    
    document.getElementById("jkdownBtn").onclick = function (ev) {
      var inputuser = document.getElementById('inputuser').value
      document.getElementById('inputuser').disabled = true
      var url = 'http://localhost:8080/jkdownload?emu=1&account='+inputuser+'&format=excel&extype=simple&op=export&filename=demo.wav&cpt_path=templates/tools/download.cpt';
      if(!window.loadflag){
        DynamciLoadUtil.loadCSS("./css/bootstrapModal/modal.min.css");
        if(window.jQuery){
          DynamciLoadUtil.loadJS('./js/bootstrapModal/modal.min.js',function () {
            loadModal(url);
          });
        } else{
          DynamciLoadUtil.loadJS('./js/jquery-1.10.2.min.js',function () {
            DynamciLoadUtil.loadJS('./js/bootstrapModal/modal.min.js',function () {
              loadModal(url);
            });
          })
        }
      }else {
        // $('#virtualIfm').attr('src',url);
        // å…ˆä¸æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œåœ¨index.jspä¸­å†è°ƒç”¨jsæ˜¾ç¤º
        // $("#myModal").modal('show');
        console.log('å·²ç»åŠ è½½äº†modal');
        jkAction(url, sessionStorage.getItem('token'))
      }
    }
    function jkAction(url,token) {
      if(!url) return
      var xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.responseType = "blob";  // è¿”å›ç±»å‹blob
      if(token){
        xhr.setRequestHeader('JK-Token', token); //è®¾ç½®è¯·æ±‚å¤´
      }else{
        $('#virtualIfm').attr('src',url);
        return;
      }
      xhr.onload = function () {
        if (xhr.status === 200) {
          if(xhr.getResponseHeader('RedirectFlag') == 'Y'){
            console.log(xhr.response);
            const blob = new Blob([xhr.response])
            var reader = new FileReader();
            reader.readAsText(blob, 'utf-8');
            reader.onload = function (e) {
              console.info(reader.result);
              console.log(JSON.parse(reader.result));
              var final_url = JSON.parse(reader.result).redirectUrl
              jkAction(final_url, sessionStorage.getItem('token'))
            }
            return;
          }
          const dispoition = xhr.getResponseHeader('Content-Disposition') || ''
          const nameStr = dispoition.split(';')[1] || ''
          let fileName = nameStr.split('=')[1] || ''
          console.log(fileName,'ä¹±ç ')
          fileName = decodeURIComponent(escape(fileName))
          const blob = new Blob([xhr.response])
          const a = document.createElement('a')
          a.href = URL.createObjectURL(blob)
          a.download = fileName  //a.download = 'å†å²æ•°æ®.xlsx'; // æˆåŠŸ
          a.click();
        }
        else {
          //è¯·æ±‚å¤±è´¥å¤„ç†
        }
      };
      // å‘é€ajaxè¯·æ±‚
      xhr.send(JSON.stringify({foo:'bar'}))
    }

    function loadModal(url) {
        var html = '<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">\n' +
            '                              <div class="modal-dialog" role="document">\n' +
            '                                <div class="modal-content" >\n' +
            '                                  <div class="modal-header">\n' +
            '                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" id="_close">&times;</span></button>\n' +
            '                                    <h5 class="modal-title" id="myModalLabel">åŠ è½½ä¸­â€¦â€¦</h5>\n' +
            '                                  </div>\n' +
            '                                  <div class="modal-body" style="padding:0;height: 350px;width: 250px;">\n' +

            '<iframe id = "virtualIfm" src="" frameborder="no" border=0 scrolling="no" height="350" width="560"/>\n' +
            '                                  </div>\n' +
            '                                </div>\n' +
            '                              </div>\n' +
            '                            </div> ';
        $('body').append(html);
        jkAction(url, sessionStorage.getItem('token'))
        // å…ˆä¸æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œå¦‚æœfilterä¸­è·³è½¬é‡‘åº“index.jspåï¼Œå†åœ¨index.jspä¸­å†è°ƒç”¨jsæ˜¾ç¤º
        //$("#myModal").modal('show');

        window.addEventListener('message', function (e){
          var msgObj = JSON.parse(e.data)
          if(msgObj.type === 'close'){
            $('#_close').click()
          }
          if(msgObj.myModalLabel){
            $('#myModalLabel').html(msgObj.myModalLabel)
          }
          if (msgObj.src){
            var lasturl = msgObj.src // çº¿ä¸Šç”¨èµ„æºçš„ä¸Šä¸‹æ–‡æ›¿æ¢ æ¯”å¦‚ msgObj.src.replace('/treasury/', '/WebReport/') 
            console.log('msgObj',msgObj)
            if (msgObj.token){
              sessionStorage.setItem('token', msgObj.token)
              document.getElementById('token-in-sessionStorage').innerHTML = 'token-in-sessionStorage >> ' + msgObj.token
            }
            
            lasturl = 'http://localhost:8080' + lasturl // ğŸ˜—ğŸ‘½ğŸ‘º çº¿ä¸Šä¸éœ€è¦è¿™ä¸€æ­¥ï¼ï¼ï¼ğŸ‘¹ğŸ’€ğŸ‘¿
            jkAction(lasturl, msgObj.token)
          }
          if(msgObj.type === 'hide'){
            $("#myModal").modal('hide');
          }
          if(msgObj.type === 'show'){
            $("#myModal").modal('show');
          }
        })
        if(!window.loadflag){
            $('#_close').click(function () {
                $("#myModal").modal('hide');
                $('#virtualIfm').attr('src',"");
            })
        }
        window.loadflag = true;
    }
 </script>
</body>
</html>
